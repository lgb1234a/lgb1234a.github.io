<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CoreMotionè®¡ç®—è®¾å¤‡yawæ–¹å‘çš„æ—‹è½¬è§’åº¦ Â· Chenyn</title><meta name="description" content="CoreMotionè®¡ç®—è®¾å¤‡yawæ–¹å‘çš„æ—‹è½¬è§’åº¦ - chenynle@gmail.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Chenyn"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/1780200685" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lgb1234a" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">CoreMotionè®¡ç®—è®¾å¤‡yawæ–¹å‘çš„æ—‹è½¬è§’åº¦</h1><div class="post-info">Apr 1, 2018</div><div class="post-content"><blockquote>
<p>å…ˆè¯´è¯´å…¬å¸éœ€æ±‚å§ï¼Œè¿™ä¸ªéœ€æ±‚é‡Œé¢æœ‰ä¸€ä¸ªéƒ¨åˆ†è¦åšä¸€ä¸ªé›·è¾¾ï¼Œè¿™ä¸ªé›·è¾¾è¦ç›‘å¬æˆ‘çš„è®¾å¤‡æ²¿yè½´æ—‹è½¬<strong>ï¼ˆä¸ºå•¥æ˜¯yè½´ä¸‹é¢ä¼šæåˆ°ï¼‰</strong>çš„å€¾è§’ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå€¾è§’ï¼Œé›·è¾¾å¯ä»¥åˆ¤æ–­å½“å‰ä½ç½®çš„ç‰©ä½“æ˜¯å¦åœ¨æˆ‘çš„é•œå¤´èŒƒå›´å†…ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="å…ˆæŒ–ä¸€ä¸ªå‘"><a href="#å…ˆæŒ–ä¸€ä¸ªå‘" class="headerlink" title="å…ˆæŒ–ä¸€ä¸ªå‘"></a>å…ˆæŒ–ä¸€ä¸ªå‘</h2><p>å…³äºé™€èºä»ªçš„åˆ›å»ºå’Œç”¨æ³•æˆ‘è¿™é‡ŒæŒ‰ä¸‹ä¸æï¼Œå› ä¸ºé‡åˆ°è¿™ä¸ªé—®é¢˜çš„å°ä¼™ä¼´å¯¹äºè·å–<code>CMDeviceMotion</code>å¯¹è±¡åº”è¯¥æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ï¼ˆ<strong>å•¥ï¼Œä½ è¯´æœ‰ï¼Ÿé‚£å°±å‡ºé—¨ç™¾åº¦é™€èºä»ªç”¨æ³•æˆ–è€…å‚è€ƒæˆ‘åé¢ç»™å‡ºçš„<a href="https://github.com/lgb1234a/TNMapARDemo" target="_blank" rel="noopener">demo</a></strong>ï¼‰</p>
<p><strong>ä¸‹é¢æ˜¯ç¬¬ä¸€ä¸ªéœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼š</strong>ç³»ç»Ÿæä¾›çš„<code>block</code>æ˜¯åœ¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦åšUIæ“ä½œï¼Œè¯·å›åˆ°ä¸»çº¿ç¨‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//Pushæ–¹å¼è·å–å’Œå¤„ç†æ•°æ®</span><br><span class="line">__weak typeof(self) weafSelf = self;</span><br><span class="line">[self.motionManager startDeviceMotionUpdatesToQueue:queue withHandler:^(CMDeviceMotion * _Nullable motion, NSError * _Nullable error) &#123;</span><br><span class="line">    // é¦–å…ˆè¿™é‡Œæ˜¯åœ¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹ï¼Œè¦åˆ·æ–°UIæ“ä½œçš„è¯ï¼Œéœ€è¦å›åˆ°ä¸»çº¿ç¨‹ã€‚</span><br><span class="line">    [weafSelf updateRadarStatuWithDeviceMotion:motion];</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure></p>
<p>ç°åœ¨ï¼Œæ‹¿åˆ°äº†æˆ‘ä»¬è¦çš„<code>CMDeviceMotion</code>å¯¹è±¡ï¼Œè¦è·å–æ—‹è½¬è§’åº¦ï¼Œè‡ªç„¶è¦æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„é‚£ä¸ªå‚æ•°ï¼Œå…ˆè¯·çœ‹ä¸‹å›¾ï¼ˆ<a href="http://blog.denivip.ru/index.php/2013/07/the-art-of-core-motion-in-ios/?lang=en" target="_blank" rel="noopener">å›¾ç‰‡æ¥æºï¼Œæœ‰ç²¾åŠ›çš„åŒå­¦å¯ä»¥çœ‹çœ‹è¿™ç¯‡æ–‡ç« ï¼Œé‡Œé¢éå¸¸ç³»ç»Ÿçš„è§£é‡Šäº†CoreMotioné‡Œé¢ä¸€äº›ç°è±¡çš„æˆå› ï¼Œæœ‰äº›å‘æˆ‘ä¹Ÿæ˜¯åœ¨è¿™é‡Œæ‰¾åˆ°è§£å†³æ–¹æ¡ˆçš„</a>ï¼‰ï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1445324-61b222ffc7193549.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/400" alt="CoreMotionRotationAxes.png"></p>
<p>ç°åœ¨çŸ¥é“äº†æˆ‘ä»¬éœ€è¦è·å–yè½´æ—‹è½¬è§’åº¦çš„åŸå› <strong>ï¼ˆxè½´ï¼Œzè½´åŒç†ï¼Œå°±æ²¡å¿…è¦ä¸€ä¸€ä»‹ç»äº†ï¼‰</strong>ï¼Œæˆ‘æŠŠå…³äºè®¾å¤‡å½“å‰æ”¾ç½®çŠ¶æ€çš„ä»£ç ç›´æ¥æŒ‘å‡ºæ¥äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//4 ä»£ç æ¥è‡ªä¸Šé¢æˆ‘å¸Œæœ›å¤§å®¶å»çœ‹çš„é‚£ç¯‡æ–‡ç« </span><br><span class="line">CMAttitude *attitude = self.motionManager.deviceMotion.attitude;</span><br><span class="line">self.pitch.text = [NSString stringWithFormat:@&quot;%.3f&quot;, attitude.pitch];</span><br><span class="line">self.roll.text = [NSString stringWithFormat:@&quot;%.3f&quot;, attitude.roll];</span><br><span class="line">self.yaw.text = [NSString stringWithFormat:@&quot;%.3f&quot;, attitude.yaw];</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>yaw</code>å°±æ˜¯è®¾å¤‡ç»•yè½´çš„åè½¬è§’åº¦ï¼Œå½“æ—¶æ»¡å¿ƒæ¬¢å–œæ‹¿è¿™ä¸ªæ•°æ®å»æ—‹è½¬é›·è¾¾ä¸­çš„é•œå¤´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// yawè§’åº¦ä¸ºé›¶çš„æ—¶å€™ï¼Œå°±æ˜¯å‡ºç”Ÿç‚¹ä½ç½®ï¼ˆæ³¨æ„è¿™ä¸€å—ä»£ç éœ€è¦æ”¾åœ¨ä¸»çº¿ç¨‹ä¸­æ“ä½œï¼Œå‚è€ƒ[demo](https://github.com/lgb1234a/TNMapARDemo)ï¼‰</span><br><span class="line">self.radarBackImgView.layer.anchorPoint = CGPointMake(0.5, 0.5);</span><br><span class="line">self.radarBackImgView.transform = CGAffineTransformMakeRotation(yaw);</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·åšï¼Œä¹ä¸€çœ‹ç¡®å®å®ç°äº†æˆ‘çš„éœ€æ±‚ï¼Œé›·è¾¾ä¸­æ˜¾ç¤ºçš„é•œå¤´ç¡®å®å’Œæˆ‘è®¾å¤‡æ—‹è½¬æ˜¯åŒæ­¥çš„ï¼Œ<strong>ä½†æ˜¯å‘¢ï¼Œçœ‹ä¸‹é¢åŠ¨å›¾ï¼š</strong></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1445324-4005cd4b9a18b617.gif?imageMogr2/auto-orient/strip" alt="å¤§è¾‰å“¥å¼ºåŠ¿å‡ºé•œğŸ˜‚.gif"></p>
<p><strong>æˆ‘ç°åœ¨å°†è®¾å¤‡ä¸Šä¸‹æ—‹è½¬ï¼Œæ³¨æ„çœ‹å³ä¸Šè§’çš„é›·è¾¾ï¼Œå±…ç„¶ä¹Ÿä¼šå‡ºç°æ—‹è½¬çš„æƒ…å†µï¼Œè¿™è¯´æ˜yawè¿™ä¸ªå€¼ä¼šè¢«rollå’Œpitchå½±å“ï¼ŒåŸæ–‡è¯´æ˜ï¼š</strong></p>
<p><code>At the first glance, nothing is complex here. All the angles duly change their value at device rotation. However, if we look closer, we can see that yaw can sometimes flip by somewhat 180 degrees at other anglesâ€™ change. So it means that changes in roll and pitch can affect yaw.</code></p>
<p><code>This post provides details of the issue called gimbal lock, along with its effect on Euler angles. The author also has mentioned the 180 degrees flip which you surely would like to avoid if animation of any on-screen objects depends on yaw.</code></p>
<p>å¯¹ï¼Œä½ é‡åˆ°äº†è‘—åçš„<strong>ä¸‡å‘èŠ‚æ­»é”é—®é¢˜</strong>ï¼ŒæƒŠä¸æƒŠå–œï¼Œæ„ä¸æ„å¤–ï¼Ÿæ‰€ä»¥ä½œè€…ç‰¹æ„å‘ŠçŸ¥å¤§å®¶ï¼Œ<strong>ä¸è¦ä¾èµ–yawè¿™ä¸ªå±æ€§å»åšä»»ä½•å±å¹•ä¸Šæ§ä»¶çš„åŠ¨ç”»ã€‚</strong></p>
<p>å¥½äº†ï¼Œå‘è²Œä¼¼å·²ç»è¯´å¾—å¾ˆæ˜ç¡®äº†ï¼Œå¦‚æœè¿˜è§‰å¾—äº‘é‡Œé›¾é‡Œçš„ï¼Œå¼ºçƒˆå»ºè®®å»çœ‹æˆ‘ä¸Šé¢è¯´çš„é‚£ç¯‡<a href="http://blog.denivip.ru/index.php/2013/07/the-art-of-core-motion-in-ios/?lang=en" target="_blank" rel="noopener">åŸæ–‡</a>ï¼Œä½œè€…è¯´çš„éå¸¸è¯¦ç»†ï¼ï¼</p>
<h2 id="é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ"><a href="#é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ" class="headerlink" title="é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ"></a>é‚£æˆ‘ä»¬è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ</h2><p>å†æ¥çœ‹çœ‹é‚£ç¯‡æ–‡ç« é‡Œé¢è¿˜è¯´äº†ä»€ä¹ˆï¼ˆè†œæ‹œä½œè€…å¤§å¤§ï¼‰ï¼š</p>
<p><code>The post also mentions that a common way to avoid gimbal lock is to avoid Euler angles in favor of other ways of describing spacial orientation. Particularly, you can use quaternions.</code></p>
<p><strong>ä½œè€…è¯´ï¼Œä¸ºäº†é¿å…ä¸‡å‘èŠ‚æ­»é”é—®é¢˜</strong>ï¼ˆè¯´æœ¯è¯­çš„æ„Ÿè§‰å¥½çˆ½å•Šï¼Œä»¥åå¯ä»¥å‡ºå»å¹æ¯”äº†ï¼šä½ çŸ¥é“å•¥å«ä¸‡å‘èŠ‚æ­»é”å—ï¼Ÿå’³~æ­£ç»ç‚¹ï¼ï¼‰<strong>ï¼Œå°±ä¸è¦ç”¨è¿™ä¸ªç³»ç»Ÿç›´æ¥è¿”å›ç»™ä½ çš„æ¬§æ‹‰è§’åº¦</strong>ï¼ˆå“ï¼Œå¤ªå»‰ä»·çš„ä¸œè¥¿å°±æ˜¯ä¸å¥½ç”¨ï¼‰ï¼Œ<strong>é‚£æˆ‘ä»¬ç”¨å•¥å•Šï¼Ÿè´´å¿ƒçš„ä½œè€…è¯´äº†ï¼Œä½ å¯ä»¥ç”¨<code>quaternions</code></strong>ï¼ˆè¿™ç©æ„é€¼æ ¼æ›´é«˜ï¼Œä¸ä¿¡ä½ å»ç»´åŸºç™¾ç§‘æœ<code>å››å…ƒæ•°</code>ï¼Œé‰´äºæˆ‘ç°åœ¨æ²¡ç©ºæ·±æŒ–ç†è®ºï¼Œ<em>ä¹ŸæŒ–ä¸åŠ¨</em>ğŸ˜‚ï¼‰ã€‚</p>
<p>ç°åœ¨çŸ¥é“äº†è¦ç”¨<strong>å››å…ƒæ•°</strong>å»åšï¼Œå¯æ˜¯ä½œè€…ä½ æ²¡è¯´å®Œå•Šï¼Œæˆ‘åªçŸ¥é“è¦ç”¨å®ƒï¼Œä½†æ˜¯è¿˜æ— ä»ä¸‹æ‰‹~</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1445324-8fb8b6402c01223e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/480" alt="CMAttitudeçš„å±æ€§.png"></p>
<p>æœ€ååªèƒ½æ±‚åŠ©äºä¸‡èƒ½çš„ggï¼š</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1445324-a182333fe5098540.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/480" alt="æœç´¢é¡¹.png"></p>
<p>å—¯ï¼Œç»“æœæœ‰éå¸¸å¤šï¼Œçœ‹æ¥è¸©å‘çš„äººä¸å°‘ï¼Œå„è·¯ç®—æ³•ç®€ç›´ç³ç…æ»¡ç›®ï¼Œæˆ‘å°±ä¸ç»™å¤§å®¶ä¸€ä¸€ç”„åˆ«äº†ï¼Œç›´æ¥ä¸Šæˆ‘æ‰¾åˆ°çš„æœ€æ»¡æ„çš„ç®—æ³•ï¼Œå®Œç¾è§£å†³äº†æˆ‘ç°åœ¨é‡åˆ°çš„é—®é¢˜ï¼Œ<a href="https://en.wikipedia.org/wiki/Conversion_between_quaternions_and_Euler_angles" target="_blank" rel="noopener">ç»´åŸºç™¾ç§‘-ã€ŠConversion between quaternions and Euler anglesã€‹</a>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static void toEulerianAngle(const Quaterniond&amp; q, double&amp; roll, double&amp; pitch, double&amp; yaw)</span><br><span class="line">&#123;</span><br><span class="line">double ysqr = q.y() * q.y();</span><br><span class="line"></span><br><span class="line">// roll (x-axis rotation)</span><br><span class="line">double t0 = +2.0 * (q.w() * q.x() + q.y() * q.z());</span><br><span class="line">double t1 = +1.0 - 2.0 * (q.x() * q.x() + ysqr);</span><br><span class="line">roll = std::atan2(t0, t1);</span><br><span class="line"></span><br><span class="line">// pitch (y-axis rotation)</span><br><span class="line">double t2 = +2.0 * (q.w() * q.y() - q.z() * q.x());</span><br><span class="line">t2 = ((t2 &gt; 1.0) ? 1.0 : t2);</span><br><span class="line">t2 = ((t2 &lt; -1.0) ? -1.0 : t2);</span><br><span class="line">pitch = std::asin(t2);</span><br><span class="line"></span><br><span class="line">// yaw (z-axis rotation)</span><br><span class="line">double t3 = +2.0 * (q.w() * q.z() + q.x() * q.y());</span><br><span class="line">double t4 = +1.0 - 2.0 * (ysqr + q.z() * q.z());</span><br><span class="line">yaw = std::atan2(t3, t4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å—¯ï¼Œè¿™æ˜¯ä¸ªC++çš„ç®—æ³•ï¼ˆåºŸè¯ï¼ï¼‰ï¼Œç„¶åå„ä½å¯ä»¥æŒ‰ç…§è‡ªå·±çš„éœ€æ±‚ï¼Œå¥—ç”¨ä¸€ä¸‹ï¼Œè‡³å°‘å¯¹æˆ‘çš„ä¸šåŠ¡æ¥è¯´ï¼Œæ˜¯å®Œå…¨OKçš„~</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/04/01/Xcode-8åœ¨iOS9-3ä¹‹å‰çš„è®¾å¤‡ï¼ˆçœŸæœºæˆ–æ¨¡æ‹Ÿå™¨ï¼‰ä¸Šè°ƒè¯•ï¼Œé¢‘ç¹crashï¼Œcrashä½ç½®éšæœºï¼Œä¸”æ— å´©æºƒåŸå›  /" class="prev">prev_post</a><a href="/2018/04/01/swiftå¯†æ–‡è¾“å…¥UITextfieldå†…å­˜é—®é¢˜/" class="next">next_post</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'chenyn';
var disqus_identifier = '2018/04/01/CoreMotion/';
var disqus_title = 'CoreMotionè®¡ç®—è®¾å¤‡yawæ–¹å‘çš„æ—‹è½¬è§’åº¦';
var disqus_url = 'http://yoursite.com/2018/04/01/CoreMotion/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//chenyn.disqus.com/count.js" async></script><div class="copyright"><p>Â© 2018 <a href="http://yoursite.com">chenynle@gmail.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>
<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Flutter iOS实战随笔 · Chenyn</title><meta name="description" content="Flutter iOS实战随笔 - chenynle@gmail.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Chenyn"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/1780200685" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lgb1234a" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Flutter iOS实战随笔</h1><div class="post-info">Sep 16, 2019</div><div class="post-content"><blockquote>
</blockquote>
<p>回到南昌半年，五味杂陈。本来项目代码就这种混乱，加之各种原因下（之前的开发人员通过隐藏支付入口来绕开应用审核，因为一次审核被拒后，由于技术的英文水平不行，没按照苹果提供的解决思路而是采用了歪门邪道，我也是醉了），应用被封1年，账号主体被冻结。所以在保证现有开发新需求的前提下，重写重构整个项目再重新上架成了重中之重。在讨论过swift还是flutter之后，我决定采用flutter，毕竟公司还有闲置的安卓开发人员，希望借助他们可以快速完成一些flutter端开发，iOS开发人员可以专注native和IM开发。</p>
<p>在利用闲暇时间调研和学习之后，打算记录一下这段时间遇到的主要几个问题，以随笔的形式记录下来。</p>
<a id="more"></a>
<h1 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h1><p>基于云信IM实现的类微信IM聊天框架（iOS可运行，Android暂未实现）</p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">app/</span><br><span class="line">|---- android  #暂无</span><br><span class="line">|---- images   #flutter侧 图片文件目录</span><br><span class="line">|---- ios      #ios 工作区</span><br><span class="line">Appdelegate   </span><br><span class="line">|---- Runner       #iOS 业务代码区</span><br><span class="line">|---- Contacts    #通讯录（纯flutter UI）</span><br><span class="line">|---- Hybird      #flutter&amp;native交互bridge</span><br><span class="line">|---- Login       #为空，目前登录UI为纯flutter页面</span><br><span class="line">|---- Mine        #我的（纯flutter UI）</span><br><span class="line">|---- Session     #会话（嵌套的云信IM页面）</span><br><span class="line">|---- lib   #flutter 代码</span><br><span class="line">|---- Base # 网络请求、util、hybird bridge</span><br><span class="line">|---- Contacts  # 通讯录UI</span><br><span class="line">|---- Login  #登录页UI</span><br><span class="line">|---- Mine   #我的</span><br><span class="line">|---- Session   #会话页</span><br><span class="line">main.dart  #flutter 入口以及页面路由</span><br><span class="line">|---- nim_sdk_util  #云信SDK服务的插件</span><br><span class="line">|---- wx_sdk    #微信登录、分享的插件</span><br></pre></td></tr></table></figure>
<h2 id="框架思路（遇到的几个问题）"><a href="#框架思路（遇到的几个问题）" class="headerlink" title="框架思路（遇到的几个问题）"></a>框架思路（遇到的几个问题）</h2><h3 id="如何管理页面堆栈"><a href="#如何管理页面堆栈" class="headerlink" title="如何管理页面堆栈"></a>如何管理页面堆栈</h3><p>在解决这个问题的时候，我走了很多弯路，一开始打算是flutter为主，native为辅（毕竟是从零开始的新项目），然后在管理堆栈的时候遇到很多挑战，这种做法在flutter–push–&gt;flutter很简单，当我要flutter–push–&gt;native或者native–push–&gt;flutter的时候，就蒙圈了。当时找了闲鱼的flutter_boost解决方案，奈何他们的flutter版本还未支持到1.7，集成进来之后各种问题，遂放弃之。</p>
<p>随后我改变思路，采用以native为骨架，flutter为血肉的方式将我这个剪不断理还乱的工程重构了一遍。先抽出来一个继承自<code>FlutterViewController</code>的基类<code>CJViewController</code>，然后提供一个初始化方法<code>- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</code>，通过<code>FlutterViewController</code>的<code>setInitialRoute</code>方法，这样外界传入一个自定义好的路由url，就可以解析到对应的flutter页面，并且可以由native来进行堆栈管理，当然也可以采用flutter <code>Navigator</code>的转场方式跳转到另一个flutter页面。</p>
<p><code>flutter</code>侧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map params = &#123;&apos;route&apos;:&apos;setting&apos;,&apos;channel_name&apos;:&apos;com.zqtd.cajian/setting&apos;&#125;;</span><br><span class="line">String pStr = convert.jsonEncode(params);</span><br><span class="line">platform.invokeMethod(&apos;pushViewControllerWithOpenUrl:&apos;, [pStr]);</span><br></pre></td></tr></table></figure></p>
<p><code>native</code>侧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSString *openUrl = @&quot;&#123;\&quot;route\&quot;:\&quot;login_entrance\&quot;,\&quot;channel_name\&quot;:\&quot;com.zqtd.cajian/login_entrance\&quot;&#125;&quot;;</span><br><span class="line">CJViewController *nextVc = [[CJViewController alloc] initWithFlutterOpenUrl:openUrl];</span><br><span class="line">[self.navigationController pushViewController:nextVc</span><br><span class="line">animated:YES];</span><br></pre></td></tr></table></figure></p>
<h3 id="如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base-里面的代码）"><a href="#如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base-里面的代码）" class="headerlink" title="如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base/里面的代码）"></a>如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base/里面的代码）</h3><p>在集成微信登录sdk插件的时候，我并不想只是简单的将微信sdk的方法简单的bridge一遍，然后交给flutter调用。我希望在<code>sendReq</code>的同时，我的插件可以处理回调，并一气呵成的完成微信登录的整套操作，包括调用我的网络请求，进行登录提示。但是我不可能把native主工程的代码再在插件pod bridge代码里面再重写一遍，这样即低效又丑陋。我想到了flutter插件的podspec可以依赖其他的pod代码，于是我尝试把我需要用的常用代码（网络请求，弹窗组件，扩展方法等）封装成私有仓库，然后再在插件的podspec里面添加这个依赖，事实证明这样是可行的，由此我便实现了在微信sdk插件里面完成整套微信登录流程。</p>
<h3 id="如何进行跨平台通信"><a href="#如何进行跨平台通信" class="headerlink" title="如何进行跨平台通信"></a>如何进行跨平台通信</h3><p>这一块也是我初学时比较头疼的，按照官方的思路，传递根视图控制器的<code>binaryMessenger</code>注册channel，然后在flutter页面完成对应的注册操作就可以建立通信了。在一开始我采用flutter嵌套native的框架思路时，发现当我登录完成，替换我的keywindow的根视图之后，我的通信就中断了。后来我发现每次当你的flutter路由被native切断，你就需要重新注册你的channel，不然你的消息就无法传递下去。而我实现公共bridge方法的目的是，我可以通过它在任何地方进行双端的通信。于是在我完成页面堆栈的管理之后，在我的基类<code>CJViewController</code>初始化方法里，注册这个同名channel，这样不管我是在native页面还是flutter页面，获取到的channel都是同一个。</p>
<p>当我一个flutter页面需要调用一些native操作时，我可以通过创建<code>CJViewController</code>的子类，在<code>- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</code>的openUrl里面指定我的channelName，然后完成一个独立的私有的通道。</p>
<p><code>CJViewController.h</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">初始化一个flutter 页面，以FlutterVC为容器</span><br><span class="line"></span><br><span class="line">\\******</span><br><span class="line">需要的JSON字符串格式如下</span><br><span class="line">&#123;</span><br><span class="line">&apos;route&apos;:&apos;login&apos;,</span><br><span class="line">&apos;channel_name&apos;:&apos;com.zqtd.cajian/login&apos;,</span><br><span class="line">&apos;params&apos;:&#123;</span><br><span class="line">&apos;team_id&apos;:&apos;298ssdj9238&apos;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">*******\\</span><br><span class="line">@param openUrl 页面初始化路由和参数</span><br><span class="line"></span><br><span class="line">@return 返回VC</span><br><span class="line">*/</span><br><span class="line">- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</span><br></pre></td></tr></table></figure>
<p><code>CJViewController.m</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl</span><br><span class="line">&#123;</span><br><span class="line">self = [super initWithProject:nil</span><br><span class="line">nibName:nil</span><br><span class="line">bundle:nil];</span><br><span class="line">if(self) &#123;</span><br><span class="line">[self setInitialRoute:openUrl];</span><br><span class="line">[self registerChannel];</span><br><span class="line"></span><br><span class="line">NSDictionary *params = [NSDictionary cj_dictionary:openUrl];</span><br><span class="line"></span><br><span class="line">// 设置回调</span><br><span class="line">_mc = [FlutterMethodChannel methodChannelWithName:params[@&quot;channel_name&quot;] binaryMessenger:self.engine.binaryMessenger];</span><br><span class="line"></span><br><span class="line">__weak typeof(self) wself = self;</span><br><span class="line">[_mc setMethodCallHandler:^(FlutterMethodCall * _Nonnull call, FlutterResult  _Nonnull result) &#123;</span><br><span class="line">ZZLog(@&quot;flutter call :%@&quot;, call.method);</span><br><span class="line">SEL callMethod = NSSelectorFromString(call.method);</span><br><span class="line">if([wself respondsToSelector:callMethod]) &#123;</span><br><span class="line">[wself performSelector:callMethod</span><br><span class="line">withObject:call.arguments</span><br><span class="line">afterDelay:0];</span><br><span class="line">&#125;else &#123;</span><br><span class="line">ZZLog(@&quot;%@未实现%@&quot;, NSStringFromClass(wself.class), call.method);</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">// 渲染完成</span><br><span class="line">[self setFlutterViewDidRenderCallback:^&#123;</span><br><span class="line">//            [_mc invokeMethod:@&quot;会在widget build完成之后调用&quot; arguments:nil];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/// util </span><br><span class="line">- (void)registerChannel</span><br><span class="line">&#123;</span><br><span class="line">__weak typeof(self) weakSelf = self;</span><br><span class="line"></span><br><span class="line">_utilChannel = [FlutterMethodChannel</span><br><span class="line">methodChannelWithName:@&quot;com.zqtd.cajian/util&quot;</span><br><span class="line">binaryMessenger:self.engine.binaryMessenger];</span><br><span class="line"></span><br><span class="line">[_utilChannel setMethodCallHandler:^(FlutterMethodCall *call, FlutterResult result) &#123;</span><br><span class="line">SEL callMethod = NSSelectorFromString(call.method);</span><br><span class="line">if([weakSelf respondsToSelector:callMethod])</span><br><span class="line">&#123;</span><br><span class="line">[weakSelf performSelector:callMethod</span><br><span class="line">withObject:call.arguments</span><br><span class="line">afterDelay:0];</span><br><span class="line">&#125;else &#123;</span><br><span class="line">[CJUtilBridge bridgeCall:call result:result];</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">// Do any additional setup after loading the view.</span><br><span class="line">// (@&quot;view did load --- 会在widget build开始之前调用&quot;);</span><br><span class="line">[GeneratedPluginRegistrant registerWithRegistry:self];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 从flutter发来的push新页面操作</span><br><span class="line">- (void)pushViewControllerWithOpenUrl:(NSArray *)params</span><br><span class="line">&#123;</span><br><span class="line">NSString *openUrl = params.firstObject;</span><br><span class="line">CJViewController *nextVc = [[CJViewController alloc] initWithFlutterOpenUrl:openUrl];</span><br><span class="line">[self.navigationController pushViewController:nextVc</span><br><span class="line">animated:YES];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 推出当前页</span><br><span class="line">- (void)popFlutterViewController</span><br><span class="line">&#123;</span><br><span class="line">[self.navigationController popViewControllerAnimated:YES];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc</span><br><span class="line">&#123;</span><br><span class="line">ZZLog(@&quot;%@ - dealloced!&quot;, NSStringFromClass(self.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>flutter侧解析路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Widget _widgetForRoute(String openUrl) &#123;</span><br><span class="line">debugPrint(&apos;FlutterViewController openUrl:&apos; + openUrl);</span><br><span class="line">dynamic initParams = json.decode(openUrl);</span><br><span class="line"></span><br><span class="line">String route = initParams[&apos;route&apos;];</span><br><span class="line">String cn = initParams[&apos;channel_name&apos;];</span><br><span class="line">Map params = initParams[&apos;params&apos;];</span><br><span class="line">switch (route) &#123;</span><br><span class="line">case &apos;login_entrance&apos;:</span><br><span class="line">return new LoginEntrance(channelName: cn);</span><br><span class="line">case &apos;mine&apos;:</span><br><span class="line">return new MineWidget(cn);</span><br><span class="line">case &apos;contacts&apos;:</span><br><span class="line">return new ContactsWidget(params);</span><br><span class="line">case &apos;setting&apos;:</span><br><span class="line">return new SettingWidget(cn);</span><br><span class="line">default:</span><br><span class="line">return MaterialApp(</span><br><span class="line">home: Scaffold(</span><br><span class="line">body: Center(child: Text(&apos;未找到route为: $route 的页面&apos;)),</span><br><span class="line">),</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">runApp(_widgetForRoute(ui.window.defaultRouteName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>demo还不够完善，但是对于目前app重构的思路已经很清晰了，希望下篇可以来一个完整的回顾。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/05/29/iOS项目拆分后xib导致的崩溃异常/" class="next">next_post</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'chenyn';
var disqus_identifier = '2019/09/16/Flutter iOS实战随笔/';
var disqus_title = 'Flutter iOS实战随笔';
var disqus_url = 'http://yoursite.com/2019/09/16/Flutter iOS实战随笔/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//chenyn.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2019 <a href="http://yoursite.com">chenynle@gmail.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>
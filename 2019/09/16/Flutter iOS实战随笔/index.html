<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Flutter iOS实战随笔（重构之旅） · Chenyn</title><meta name="description" content="Flutter iOS实战随笔（重构之旅） - chenynle@gmail.com"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.jpeg"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Chenyn"><meta name="generator" content="Hexo 5.0.0"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.jpeg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/1780200685" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lgb1234a" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Flutter iOS实战随笔（重构之旅）</h1><div class="post-info">Sep 16, 2019</div><div class="post-content"><blockquote>
<p>回到南昌半年，五味杂陈。本来项目代码就非常混乱，加之各种原因下（之前的开发人员通过隐藏支付入口来绕开应用审核，因为一次审核被拒后，由于技术的英文水平不行，没按照苹果提供的解决思路而是采用了歪门邪道，我也是醉了），应用被封1年，账号主体被冻结。所以在保证现有开发新需求的前提下，重写重构整个项目再重新上架成了重中之重。在讨论过swift还是flutter之后，我决定采用flutter，毕竟公司还有闲置的安卓开发人员，希望借助他们可以快速完成一些flutter端开发，iOS开发人员可以专注native和IM开发。</p>
</blockquote>
<blockquote>
<p>在利用闲暇时间调研和学习之后，打算记录一下这段时间遇到的主要几个问题，以随笔的形式记录下来。</p>
</blockquote>
<a id="more"></a>


<h1 id="quote"><a href="#quote" class="headerlink" title="quote"></a>quote</h1><p><del>基于云信IM实现的类微信IM聊天框架（iOS可运行，Android暂未实现）</del><br><strong>在前期实践后，发现了flutter+native的可行性，遂开始了项目的重构之路。下面是重构过程的一些思考历程。</strong></p>
<h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Runner</span><br><span class="line">|</span><br><span class="line">|---- Base&#x2F; #基础代码，例如VC的基类，navigationVC的基类，pch文件</span><br><span class="line">|</span><br><span class="line">|---- Contacts&#x2F;  #通讯录模块相关代码</span><br><span class="line">|</span><br><span class="line">|---- Hybrid&#x2F;    #native和flutter桥接代码</span><br><span class="line">|</span><br><span class="line">|---- Login&#x2F;     #登录模块相关代码</span><br><span class="line">|</span><br><span class="line">|---- Mine&#x2F;      #我的模块相关代码</span><br><span class="line">|</span><br><span class="line">|---- Session&#x2F;   #会话模块相关代码</span><br><span class="line">|        |</span><br><span class="line">|        |---- NTES&#x2F;    #NIMDemo中拿过来的工具代码</span><br><span class="line">|        |</span><br><span class="line">|        |---- SessionViewController&#x2F;   #聊天页面相关代码</span><br><span class="line">|        |           |</span><br><span class="line">|        |           |---- BubbleCell&#x2F;  #气泡cell相关</span><br><span class="line">|        |           |</span><br><span class="line">|        |           |---- Config&#x2F;      #聊天session和cell的相关配置</span><br><span class="line">|        |           |</span><br><span class="line">|        |           |---- Layout&#x2F;      #cell布局的相关配置</span><br><span class="line">|        |           |</span><br><span class="line">|        |           |---- Manager&#x2F;     #支付、红包等相关业务管理类</span><br><span class="line">|        |</span><br><span class="line">|        |---- Util&#x2F;    #聊天相关工具类</span><br><span class="line">|</span><br><span class="line">|</span><br><span class="line">|____ Vendor&#x2F;    #第三方库、framework</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CJBase私有仓库:维护的独立git仓库，修改后需要在该路径下，再提交代码到远端仓库，和主工程剥离开，便于维护和依赖给flutter插件使用</span><br><span class="line">|</span><br><span class="line">|---- Base&#x2F;    #基础代码</span><br><span class="line">|</span><br><span class="line">|---- Category&#x2F;   #扩展</span><br><span class="line">|</span><br><span class="line">|____ Network&#x2F;   #网络请求相关</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="框架思路（遇到的几个问题）"><a href="#框架思路（遇到的几个问题）" class="headerlink" title="框架思路（遇到的几个问题）"></a>框架思路（遇到的几个问题）</h2><h3 id="如何管理页面堆栈"><a href="#如何管理页面堆栈" class="headerlink" title="如何管理页面堆栈"></a>如何管理页面堆栈</h3><p>在解决这个问题的时候，我走了很多弯路，一开始打算是flutter为主，native为辅（毕竟是从零开始的新项目），然后在管理堆栈的时候遇到很多挑战，这种做法在flutter–push–&gt;flutter很简单，当我要flutter–push–&gt;native或者native–push–&gt;flutter的时候，就蒙圈了。当时找了闲鱼的flutter_boost解决方案，奈何他们的flutter版本还未支持到1.7，集成进来之后各种问题，遂放弃之。</p>
<p>随后我改变思路，采用以native为骨架，flutter为血肉的方式将我这个剪不断理还乱的工程重构了一遍。先抽出来一个继承自<code>FlutterViewController</code>的基类<code>CJViewController</code>，然后提供一个初始化方法<code>- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</code>，通过<code>FlutterViewController</code>的<code>setInitialRoute</code>方法，这样外界传入一个自定义好的路由url，就可以解析到对应的flutter页面，并且可以由native来进行堆栈管理，当然也可以采用flutter <code>Navigator</code>的转场方式跳转到另一个flutter页面。</p>
<p><code>flutter</code>侧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Map params &#x3D; &#123;&#39;route&#39;:&#39;setting&#39;,&#39;channel_name&#39;:&#39;com.zqtd.cajian&#x2F;setting&#39;&#125;;</span><br><span class="line">String pStr &#x3D; convert.jsonEncode(params);</span><br><span class="line">platform.invokeMethod(&#39;pushViewControllerWithOpenUrl:&#39;, [pStr]);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>native</code>侧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSString *openUrl &#x3D; @&quot;&#123;\&quot;route\&quot;:\&quot;login_entrance\&quot;,\&quot;channel_name\&quot;:\&quot;com.zqtd.cajian&#x2F;login_entrance\&quot;&#125;&quot;;</span><br><span class="line">CJViewController *nextVc &#x3D; [[CJViewController alloc] initWithFlutterOpenUrl:openUrl];</span><br><span class="line">[self.navigationController pushViewController:nextVc</span><br><span class="line">animated:YES];</span><br></pre></td></tr></table></figure>

<h3 id="如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base-里面的代码）"><a href="#如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base-里面的代码）" class="headerlink" title="如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base/里面的代码）"></a>如何在native让我集成的插件代码也可以发起网络请求，做一些与用户的反馈交互（弹出提示框hub之类的——Base/里面的代码）</h3><p>在集成微信登录sdk插件的时候，我并不想只是简单的将微信sdk的方法简单的bridge一遍，然后交给flutter调用。我希望在<code>sendReq</code>的同时，我的插件可以处理回调，并一气呵成的完成微信登录的整套操作，包括调用我的网络请求，进行登录提示。但是我不可能把native主工程的代码再在插件pod bridge代码里面再重写一遍，这样即低效又丑陋。我想到了flutter插件的podspec可以依赖其他的pod代码，于是我尝试把我需要用的常用代码（网络请求，弹窗组件，扩展方法等）封装成私有仓库，然后再在插件的podspec里面添加这个依赖，事实证明这样是可行的，由此我便实现了在微信sdk插件里面完成整套微信登录流程。</p>
<h3 id="如何进行跨平台通信"><a href="#如何进行跨平台通信" class="headerlink" title="如何进行跨平台通信"></a>如何进行跨平台通信</h3><h5 id="版本1"><a href="#版本1" class="headerlink" title="版本1"></a>版本1</h5><p><del>这一块也是我初学时比较头疼的，按照官方的思路，传递根视图控制器的<code>binaryMessenger</code>注册channel，然后在flutter页面完成对应的注册操作就可以建立通信了。在一开始我采用flutter嵌套native的框架思路时，发现当我登录完成，替换我的keywindow的根视图之后，我的通信就中断了。后来我发现每次当你的flutter路由被native切断，你就需要重新注册你的channel，不然你的消息就无法传递下去。而我实现公共bridge方法的目的是，我可以通过它在任何地方进行双端的通信。于是在我完成页面堆栈的管理之后，在我的基类<code>CJViewController</code>初始化方法里，注册这个同名channel，这样不管我是在native页面还是flutter页面，获取到的channel都是同一个。</del></p>
<p><del>当我一个flutter页面需要调用一些native操作时，我可以通过创建<code>CJViewController</code>的子类，在<code>- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</code>的openUrl里面指定我的channelName，然后完成一个独立的私有的通道。</del></p>
<p><code>CJViewController.h</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line">初始化一个flutter 页面，以FlutterVC为容器</span><br><span class="line"></span><br><span class="line">\\******</span><br><span class="line">需要的JSON字符串格式如下</span><br><span class="line">&#123;</span><br><span class="line">&#39;route&#39;:&#39;login&#39;,</span><br><span class="line">&#39;channel_name&#39;:&#39;com.zqtd.cajian&#x2F;login&#39;,</span><br><span class="line">&#39;params&#39;:&#123;</span><br><span class="line">&#39;team_id&#39;:&#39;298ssdj9238&#39;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">*******\\</span><br><span class="line">@param openUrl 页面初始化路由和参数</span><br><span class="line"></span><br><span class="line">@return 返回VC</span><br><span class="line">*&#x2F;</span><br><span class="line">- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>CJViewController.m</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl</span><br><span class="line">&#123;</span><br><span class="line">self &#x3D; [super initWithProject:nil</span><br><span class="line">nibName:nil</span><br><span class="line">bundle:nil];</span><br><span class="line">if(self) &#123;</span><br><span class="line">[self setInitialRoute:openUrl];</span><br><span class="line">[self registerChannel];</span><br><span class="line"></span><br><span class="line">NSDictionary *params &#x3D; [NSDictionary cj_dictionary:openUrl];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 设置回调</span><br><span class="line">_mc &#x3D; [FlutterMethodChannel methodChannelWithName:params[@&quot;channel_name&quot;] binaryMessenger:self.engine.binaryMessenger];</span><br><span class="line"></span><br><span class="line">__weak typeof(self) wself &#x3D; self;</span><br><span class="line">[_mc setMethodCallHandler:^(FlutterMethodCall * _Nonnull call, FlutterResult  _Nonnull result) &#123;</span><br><span class="line">ZZLog(@&quot;flutter call :%@&quot;, call.method);</span><br><span class="line">SEL callMethod &#x3D; NSSelectorFromString(call.method);</span><br><span class="line">if([wself respondsToSelector:callMethod]) &#123;</span><br><span class="line">[wself performSelector:callMethod</span><br><span class="line">withObject:call.arguments</span><br><span class="line">afterDelay:0];</span><br><span class="line">&#125;else &#123;</span><br><span class="line">ZZLog(@&quot;%@未实现%@&quot;, NSStringFromClass(wself.class), call.method);</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 渲染完成</span><br><span class="line">[self setFlutterViewDidRenderCallback:^&#123;</span><br><span class="line">&#x2F;&#x2F;            [_mc invokeMethod:@&quot;会在widget build完成之后调用&quot; arguments:nil];</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;&#x2F; util </span><br><span class="line">- (void)registerChannel</span><br><span class="line">&#123;</span><br><span class="line">__weak typeof(self) weakSelf &#x3D; self;</span><br><span class="line"></span><br><span class="line">_utilChannel &#x3D; [FlutterMethodChannel</span><br><span class="line">methodChannelWithName:@&quot;com.zqtd.cajian&#x2F;util&quot;</span><br><span class="line">binaryMessenger:self.engine.binaryMessenger];</span><br><span class="line"></span><br><span class="line">[_utilChannel setMethodCallHandler:^(FlutterMethodCall *call, FlutterResult result) &#123;</span><br><span class="line">SEL callMethod &#x3D; NSSelectorFromString(call.method);</span><br><span class="line">if([weakSelf respondsToSelector:callMethod])</span><br><span class="line">&#123;</span><br><span class="line">[weakSelf performSelector:callMethod</span><br><span class="line">withObject:call.arguments</span><br><span class="line">afterDelay:0];</span><br><span class="line">&#125;else &#123;</span><br><span class="line">[CJUtilBridge bridgeCall:call result:result];</span><br><span class="line">&#125;</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">&#x2F;&#x2F; Do any additional setup after loading the view.</span><br><span class="line">&#x2F;&#x2F; (@&quot;view did load --- 会在widget build开始之前调用&quot;);</span><br><span class="line">[GeneratedPluginRegistrant registerWithRegistry:self];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 从flutter发来的push新页面操作</span><br><span class="line">- (void)pushViewControllerWithOpenUrl:(NSArray *)params</span><br><span class="line">&#123;</span><br><span class="line">NSString *openUrl &#x3D; params.firstObject;</span><br><span class="line">CJViewController *nextVc &#x3D; [[CJViewController alloc] initWithFlutterOpenUrl:openUrl];</span><br><span class="line">[self.navigationController pushViewController:nextVc</span><br><span class="line">animated:YES];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 推出当前页</span><br><span class="line">- (void)popFlutterViewController</span><br><span class="line">&#123;</span><br><span class="line">[self.navigationController popViewControllerAnimated:YES];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc</span><br><span class="line">&#123;</span><br><span class="line">ZZLog(@&quot;%@ - dealloced!&quot;, NSStringFromClass(self.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<p>flutter侧解析路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Widget _widgetForRoute(String openUrl) &#123;</span><br><span class="line">debugPrint(&#39;FlutterViewController openUrl:&#39; + openUrl);</span><br><span class="line">dynamic initParams &#x3D; json.decode(openUrl);</span><br><span class="line"></span><br><span class="line">String route &#x3D; initParams[&#39;route&#39;];</span><br><span class="line">String cn &#x3D; initParams[&#39;channel_name&#39;];</span><br><span class="line">Map params &#x3D; initParams[&#39;params&#39;];</span><br><span class="line">switch (route) &#123;</span><br><span class="line">case &#39;login_entrance&#39;:</span><br><span class="line">return new LoginEntrance(channelName: cn);</span><br><span class="line">case &#39;mine&#39;:</span><br><span class="line">return new MineWidget(cn);</span><br><span class="line">case &#39;contacts&#39;:</span><br><span class="line">return new ContactsWidget(params);</span><br><span class="line">case &#39;setting&#39;:</span><br><span class="line">return new SettingWidget(cn);</span><br><span class="line">default:</span><br><span class="line">return MaterialApp(</span><br><span class="line">home: Scaffold(</span><br><span class="line">body: Center(child: Text(&#39;未找到route为: $route 的页面&#39;)),</span><br><span class="line">),</span><br><span class="line">);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void main() &#123;</span><br><span class="line">runApp(_widgetForRoute(ui.window.defaultRouteName));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="版本2"><a href="#版本2" class="headerlink" title="版本2"></a>版本2</h5><p><del>在解决这个问题的时候，我走了很多弯路，一开始打算是flutter为主，native为辅（毕竟是从零开始的新项目），然后在管理堆栈的时候遇到很多挑战，这种做法在flutter–push–&gt;flutter很简单，当我要flutter–push–&gt;native或者native–push–&gt;flutter的时候，就蒙圈了。当时找了咸鱼的flutter_boost解决方案，奈何他们的flutter版本还未支持到1.7，集成进来之后各种问题，遂放弃之。</del></p>
<p><del>随后我改变思路，采用以native为骨架，flutter为血肉的方式将我这个剪不断理还乱的工程重构了一遍。先抽出来一个继承自FlutterViewController的基类CJViewController，然后提供一个初始化方法- (instancetype)initWithFlutterOpenUrl:(NSString *)openUrl;，通过FlutterViewController的setInitialRoute方法，这样外界传入一个自定义好的路由url，就可以解析到对应的flutter页面，并且可以由native来进行堆栈管理，也可以采用flutter Navigator的转场方式跳转到另一个flutter页面。</del></p>
<p><del>flutter侧：</del></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Map params &#x3D; &#123;&#39;route&#39;:&#39;setting&#39;,&#39;channel_name&#39;:&#39;com.zqtd.cajian&#x2F;setting&#39;&#125;;</span><br><span class="line">String pStr &#x3D; convert.jsonEncode(params);</span><br><span class="line">model.platform.invokeMethod(&#39;pushViewControllerWithOpenUrl:&#39;, [pStr]);</span><br></pre></td></tr></table></figure>

<p><del>native侧：</del></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NSString *openUrl &#x3D; @&quot;&#123;\&quot;route\&quot;:\&quot;login_entrance\&quot;,\&quot;channel_name\&quot;:\&quot;com.zqtd.cajian&#x2F;login_entrance\&quot;&#125;&quot;;</span><br><span class="line">CJViewController *nextVc &#x3D; [[CJViewController alloc] initWithFlutterOpenUrl:openUrl];</span><br><span class="line">[self.navigationController pushViewController:nextVc</span><br><span class="line">                                     animated:YES];</span><br></pre></td></tr></table></figure>

<p>——-       2019-12-18更新       ——–</p>
<p><strong>上述逻辑经过验证，存在严重的内存问题，在闲鱼flutter_boost支持1.7版本后，就切换成了flutter_boost方案，顺便解决了跨平台通信问题。</strong></p>
<p><strong>dart侧拉起native页面：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FlutterBoost.singleton.open(</span><br><span class="line">                &#39;nativePage:&#x2F;&#x2F;android&amp;iosPageName&#x3D;CJNewFriendViewController&#39;,</span><br><span class="line">                exts: &#123;&#39;animated&#39;: true&#125;);</span><br></pre></td></tr></table></figure>

<p><strong>native侧拉起dart页面：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[FlutterBoostPlugin open:@&quot;session_info&quot;</span><br><span class="line">                   urlParams:@&#123;@&quot;id&quot;: self.session.sessionId, @&quot;type&quot;: @(self.session.sessionType)&#125;</span><br><span class="line">                        exts:@&#123;@&quot;animated&quot;: @(YES)&#125;</span><br><span class="line">              onPageFinished:^(NSDictionary *result) &#123;&#125;</span><br><span class="line">                  completion:nil];</span><br></pre></td></tr></table></figure>

<p><strong>dart和native通信：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FlutterBoost.singleton.channel.sendEvent(&#39;handledNotification&#39;,</span><br><span class="line">        &#123;&#39;notificationId&#39;: notificationId, &#39;handleStatus&#39;: handleStatus&#125;);</span><br></pre></td></tr></table></figure>

<p>native:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[FlutterBoostPlugin sharedInstance] addEventListener:^(NSString *name, NSDictionary *arguments) &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; ......做一些操作,而且这个通知回调是同步的，不需要考虑异步问题</span><br><span class="line">    &#125; forName:@&quot;handledNotification&quot;];</span><br></pre></td></tr></table></figure>



<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><strong>这次native重构抛弃了以往基于NIMDemo工程开发的方式，需要按照既定业务来梳理所有的内容，这其中最核心的模块就是NIMKit+各类自定义消息。iOS NIMKit由cocoapods集成，方便后续维护升级，所有的自定义内容按照继承NIM类+可配置文件的形式进行。</strong></p>
<p><strong>主要针对以往在解析和配置自定义消息的时候，往往需要引入大量的自定义类，导致代码的可维护性和可读性极差等问题进行优化。优化过程中我采用了反射+协议的方式，将大量需要显示引入的自定义类，通过运行时反射找到类名，再运用协议声明，将所有的胶水代码维护在自定义类的内部，这样不仅大大提升了代码的通读性，还提升了可维护性。</strong></p>
<p>#####维护前后代码对比： AttachmentDecoder重构前</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;NTESCustomAttachmentDecoder.h&quot;</span><br><span class="line">#import &quot;NTESCustomAttachmentDefines.h&quot;</span><br><span class="line">#import &quot;NTESJanKenPonAttachment.h&quot;</span><br><span class="line">#import &quot;NTESSnapchatAttachment.h&quot;</span><br><span class="line">#import &quot;NTESChartletAttachment.h&quot;</span><br><span class="line">#import &quot;NTESWhiteboardAttachment.h&quot;</span><br><span class="line">#import &quot;NTESRedPacketAttachment.h&quot;</span><br><span class="line">#import &quot;NTESRedPacketTipAttachment.h&quot;</span><br><span class="line">#import &quot;NSDictionary+NTESJson.h&quot;</span><br><span class="line">#import &quot;NTESSessionUtil.h&quot;</span><br><span class="line">#import &quot;NTESPersonalCardAttachment.h&quot;</span><br><span class="line">#import &quot;NTESWebPageAttachment.h&quot;</span><br><span class="line">#import &quot;NTESShareAppAttachment.h&quot;</span><br><span class="line">#import &quot;NTESShareLinkAttachment.h&quot;</span><br><span class="line">#import &quot;NTESAliPayRedPacketAttachment.h&quot;</span><br><span class="line">#import &quot;NTESAliPayRedPacketTipAttachment.h&quot;</span><br><span class="line">#import &quot;NTESShakeAttachment.h&quot;</span><br><span class="line">#import &quot;NTESRecordAttachment.h&quot;</span><br><span class="line">#import &quot;NTESYouXiRedPacketTipAttachment.h&quot;</span><br><span class="line">#import &quot;NTESYouXiRedPacketAttachment.h&quot;</span><br><span class="line">#import &quot;NTESYouXiTransferAttachment.h&quot;</span><br><span class="line">#import &quot;NTESYouxiTransferReceiptAttachment.h&quot;</span><br><span class="line">#import &quot;NTESMFRedPacketAttachment.h&quot;</span><br><span class="line">#import &quot;NTESMFRedPacketTipAttachment.h&quot;</span><br><span class="line">#import &quot;NTESUpdateInfoAttachment.h&quot;</span><br><span class="line">#import &quot;NTESArticleNotificationAttachment.h&quot;</span><br><span class="line">#import &quot;NTESScreenShotsAttachment.h&quot;</span><br><span class="line">#import &quot;NTESPayAssistantAttachment.h&quot;</span><br><span class="line">#import &quot;NTESSysAssistantAttachment.h&quot;</span><br><span class="line">#import &quot;YYModel.h&quot;</span><br><span class="line">#import &quot;NTESScreenBanRedAttachment.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation NTESCustomAttachmentDecoder</span><br><span class="line">- (id&lt;NIMCustomAttachment&gt;)decodeAttachment:(NSString *)content</span><br><span class="line">&#123;</span><br><span class="line">    id&lt;NIMCustomAttachment&gt; attachment &#x3D; nil;</span><br><span class="line"></span><br><span class="line">    NSData *data &#x3D; [content dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    if (data) &#123;</span><br><span class="line">        NSDictionary *dict &#x3D; [NSJSONSerialization JSONObjectWithData:data</span><br><span class="line">                                                             options:0</span><br><span class="line">                                                               error:nil];</span><br><span class="line">        if ([dict isKindOfClass:[NSDictionary class]])</span><br><span class="line">        &#123;</span><br><span class="line">            NSInteger type     &#x3D; [dict jsonInteger:CMType];</span><br><span class="line">            NSDictionary *data &#x3D; [dict jsonDict:CMData];</span><br><span class="line">            switch (type) &#123;</span><br><span class="line">                case CustomMessageTypeJanKenPon:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESJanKenPonAttachment alloc] init];</span><br><span class="line">                    ((NTESJanKenPonAttachment *)attachment).value &#x3D; [data jsonInteger:CMValue];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeSnapchat:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESSnapchatAttachment alloc] init];</span><br><span class="line">                    ((NTESSnapchatAttachment *)attachment).md5 &#x3D; [data jsonString:CMMD5];</span><br><span class="line">                    ((NTESSnapchatAttachment *)attachment).url &#x3D; [data jsonString:CMURL];</span><br><span class="line">                    ((NTESSnapchatAttachment *)attachment).isFired &#x3D; [data jsonBool:CMFIRE];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeChartlet:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESChartletAttachment alloc] init];</span><br><span class="line">                    ((NTESChartletAttachment *)attachment).chartletCatalog &#x3D; [data jsonString:CMCatalog];</span><br><span class="line">                    ((NTESChartletAttachment *)attachment).chartletId      &#x3D; [data jsonString:CMChartlet];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeWhiteboard:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESWhiteboardAttachment alloc] init];</span><br><span class="line">                    ((NTESWhiteboardAttachment *)attachment).flag &#x3D; [data jsonInteger:CMFlag];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeRedPacket:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESRedPacketAttachment alloc] init];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).redPacketId &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).money &#x3D; [data jsonString:CMRedPacketMoney];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).count &#x3D; [[data jsonString:CMRedPacketCount] integerValue];</span><br><span class="line">                    ((NTESRedPacketAttachment *)attachment).status &#x3D; [[data jsonString:CMRedPacketStatus] integerValue];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeRedPacketTip:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESRedPacketTipAttachment alloc] init];</span><br><span class="line">                    ((NTESRedPacketTipAttachment *)attachment).sendPacketId &#x3D; [data jsonString:CMRedPacketSendId];</span><br><span class="line">                    ((NTESRedPacketTipAttachment *)attachment).packetId  &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESRedPacketTipAttachment *)attachment).isGetDone &#x3D; [data jsonString:CMRedPacketDone];</span><br><span class="line">                    ((NTESRedPacketTipAttachment *)attachment).openPacketId &#x3D; [data jsonString:CMRedPacketOpenId];</span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case CustomMessageTypeMFRedPacket:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESMFRedPacketAttachment alloc] init];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).redPacketId &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).money &#x3D; [data jsonString:CMRedPacketMoney];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).count &#x3D; [[data jsonString:CMRedPacketCount] integerValue];</span><br><span class="line">                    ((NTESMFRedPacketAttachment *)attachment).status &#x3D; [[data jsonString:CMRedPacketStatus] integerValue];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case CustomMessageTypeMFRedPacketTip:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESMFRedPacketTipAttachment alloc] init];</span><br><span class="line">                    ((NTESMFRedPacketTipAttachment *)attachment).sendPacketId &#x3D; [data jsonString:CMRedPacketSendId];</span><br><span class="line">                    ((NTESMFRedPacketTipAttachment *)attachment).packetId  &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESMFRedPacketTipAttachment *)attachment).isGetDone &#x3D; [data jsonString:CMRedPacketDone];</span><br><span class="line">                    ((NTESMFRedPacketTipAttachment *)attachment).openPacketId &#x3D; [data jsonString:CMRedPacketOpenId];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                &#x2F;&#x2F; 自定义的个人名片</span><br><span class="line">                case CustomMessageTypePersonalCard:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESPersonalCardAttachment alloc] init];</span><br><span class="line">                    ((NTESPersonalCardAttachment *)attachment).accid &#x3D; [data jsonString:CMPersonalCardAccid];</span><br><span class="line">                    ((NTESPersonalCardAttachment *)attachment).nickname  &#x3D; [data jsonString:CMPersonalCardNickName];</span><br><span class="line">                    ((NTESPersonalCardAttachment *)attachment).imageurl &#x3D; [data jsonString:CMPersonalCardUrl];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    &#x2F;&#x2F; 版本更新推送</span><br><span class="line">                case CustomMessageTypeUpdateInfo:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESUpdateInfoAttachment alloc] init];</span><br><span class="line">                    ((NTESUpdateInfoAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESUpdateInfoAttachment *)attachment).content  &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESUpdateInfoAttachment *)attachment).log_time &#x3D; [data jsonString:@&quot;log_time&quot;];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case CustomMessageTypeArticleNotification:</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 解析推文的数据</span><br><span class="line">                    attachment &#x3D; [[NTESArticleNotificationAttachment alloc] init];</span><br><span class="line">                    NSArray *articles &#x3D; [data jsonArray:@&quot;articles&quot;];</span><br><span class="line">                    ((NTESArticleNotificationAttachment *)attachment).articles &#x3D; [NSArray yy_modelArrayWithClass:NTESArticleModel.class json:articles];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    &#x2F;&#x2F; 网页分享</span><br><span class="line">                case CustomMessageTypeWebPage:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESWebPageAttachment alloc] init];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).title &#x3D; [data jsonString:CMWebPageTitle];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).content  &#x3D; [data jsonString:CMWebPageContent];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).weburl &#x3D; [data jsonString:CMWebPageUrl];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).imageData &#x3D; [data jsonString:CMWebPageImageData];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).appname &#x3D; [data jsonString:CMWebPageAppName];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).appicon &#x3D; [data jsonString:CMWebPageAppIcon];</span><br><span class="line">                    ((NTESWebPageAttachment *)attachment).extention &#x3D; [data jsonString:CMWebPageAppExtention];</span><br><span class="line">                &#125;</span><br><span class="line">                    &#x2F;&#x2F; 支红包</span><br><span class="line">                case CustomMessageTypeAliPayRedPacket:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESAliPayRedPacketAttachment alloc] init];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).redPacketId &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).money &#x3D; [data jsonString:CMRedPacketMoney];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).count &#x3D; [[data jsonString:CMRedPacketCount] integerValue];</span><br><span class="line">                    ((NTESAliPayRedPacketAttachment *)attachment).status &#x3D; [[data jsonString:CMRedPacketStatus] integerValue];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    &#x2F;&#x2F; 拆支红包</span><br><span class="line">                case CustomMessageTypeAliPayRedPacketTip:</span><br><span class="line">                &#123;</span><br><span class="line">                    attachment &#x3D; [[NTESAliPayRedPacketTipAttachment alloc] init];</span><br><span class="line">                    ((NTESAliPayRedPacketTipAttachment *)attachment).sendPacketId &#x3D; [data jsonString:CMRedPacketSendId];</span><br><span class="line">                    ((NTESAliPayRedPacketTipAttachment *)attachment).packetId  &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESAliPayRedPacketTipAttachment *)attachment).isGetDone &#x3D; [data jsonString:CMRedPacketDone];</span><br><span class="line">                    ((NTESAliPayRedPacketTipAttachment *)attachment).openPacketId &#x3D; [data jsonString:CMRedPacketOpenId];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case CustomMessageTypeYouXiRedPacket:</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 游兮红包</span><br><span class="line">                    attachment &#x3D; [[NTESYouXiRedPacketAttachment alloc] init];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).redPacketId &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).money &#x3D; [data jsonString:CMRedPacketMoney];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).count &#x3D; [[data jsonString:CMRedPacketCount] integerValue];</span><br><span class="line">                    ((NTESYouXiRedPacketAttachment *)attachment).status &#x3D; [[data jsonString:CMRedPacketStatus] integerValue];</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">                    break;</span><br><span class="line">                    </span><br><span class="line">                case CustomMessageTypeYXTransfer:</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 游兮转账</span><br><span class="line">                    attachment &#x3D; [[NTESYouXiTransferAttachment alloc] init];</span><br><span class="line">                    ((NTESYouXiTransferAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESYouXiTransferAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESYouXiTransferAttachment *)attachment).transferId &#x3D; [data jsonString:CMTransferId];</span><br><span class="line">                    ((NTESYouXiTransferAttachment *)attachment).amount &#x3D; [data jsonString:CMTransferMoney];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeYXTransferReceipt:</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 游兮转账回执</span><br><span class="line">                    attachment &#x3D; [[NTESYouxiTransferReceiptAttachment alloc] init];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).title &#x3D; [data jsonString:CMRedPacketTitle];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).content &#x3D; [data jsonString:CMRedPacketContent];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).transferId &#x3D; [data jsonString:CMTransferId];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).amount &#x3D; [data jsonString:CMTransferMoney];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).status &#x3D; [data jsonString:@&quot;transferStatus&quot;].integerValue;</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).sendPacketId &#x3D; [data jsonString:@&quot;sendPacketId&quot;];</span><br><span class="line">                    ((NTESYouxiTransferReceiptAttachment *)attachment).openPacketId &#x3D; [data jsonString:@&quot;openPacketId&quot;];</span><br><span class="line">                &#125;</span><br><span class="line">                    break;</span><br><span class="line">                case CustomMessageTypeYouXiRedPacketTip:</span><br><span class="line">                &#123;</span><br><span class="line">                    &#x2F;&#x2F; 拆游兮红包</span><br><span class="line">                    attachment &#x3D; [[NTESYouXiRedPacketTipAttachment alloc] init];</span><br><span class="line">                    ((NTESYouXiRedPacketTipAttachment *)attachment).sendPacketId &#x3D; [data jsonString:CMRedPacketSendId];</span><br><span class="line">                    ((NTESYouXiRedPacketTipAttachment *)attachment).packetId  &#x3D; [data jsonString:CMRedPacketId];</span><br><span class="line">                    ((NTESYouXiRedPacketTipAttachment *)attachment).isGetDone &#x3D; [data jsonString:CMRedPacketDone];</span><br><span class="line">                    ((NTESYouXiRedPacketTipAttachment *)attachment).openPacketId &#x3D; [data jsonString:CMRedPacketOpenId];</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">                    break;</span><br><span class="line">                    &#x2F;&#x2F; 分享游戏</span><br><span class="line">                ...后面太多了，不全部引入了</span><br></pre></td></tr></table></figure>

<p>#####AttachmentDecoder重构后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;CJCustomAttachmentDecoder.h&quot;</span><br><span class="line">#import &quot;CJCustomAttachmentDefines.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation CJCustomAttachmentDecoder</span><br><span class="line"></span><br><span class="line">- (id&lt;CJCustomAttachmentCoding&gt;)decodeAttachment:(NSString *)content</span><br><span class="line">&#123;</span><br><span class="line">    id&lt;CJCustomAttachmentCoding&gt; attachment &#x3D; nil;</span><br><span class="line">    NSData *data &#x3D; [content dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">    if(!data) &#123;</span><br><span class="line">        return nil;</span><br><span class="line">    &#125;</span><br><span class="line">    NSDictionary *dict &#x3D; [NSJSONSerialization JSONObjectWithData:data</span><br><span class="line">                                                         options:0</span><br><span class="line">                                                           error:nil];</span><br><span class="line">    if (data &amp;&amp; [dict isKindOfClass:[NSDictionary class]]) &#123;</span><br><span class="line">        NSInteger type     &#x3D; [[dict objectForKey:@&quot;type&quot;] integerValue];</span><br><span class="line">        NSDictionary *data &#x3D; [dict objectForKey:@&quot;data&quot;];</span><br><span class="line">        </span><br><span class="line">        NSString *className &#x3D; attachmentNameForType(type);</span><br><span class="line">        Class cls &#x3D; NSClassFromString(className);</span><br><span class="line">        if([cls instancesRespondToSelector:@selector(initWithPrepareData:)])</span><br><span class="line">        &#123;</span><br><span class="line">            attachment &#x3D; [[cls alloc] initWithPrepareData:data];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    attachment &#x3D; [attachment isValid]? attachment : nil;</span><br><span class="line">    return attachment;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p><strong>相对的，所有的decoder代码都维护在attachment类自身，这样在后续修改或者删除一个自定义消息的时候，不用担心会因为修改那一长串胶水代码，而会引起其他模块问题，提升了代码解耦的同时，并降低了维护成本和测试成本。还有许多类似的优化，就不一一列举了</strong></p>
<p>#####新框架下，新增自定义消息的流程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line">CJCustomAttachmentDefines类</span><br><span class="line">typedef NS_ENUM(NSInteger, CJCustomMessageType)&#123;</span><br><span class="line">    CustomMessageTypeJanKenPon  &#x3D; 1, &#x2F;&#x2F;剪子石头布</span><br><span class="line">    CustomMessageTypeSnapchat   &#x3D; 2, &#x2F;&#x2F;阅后即焚</span><br><span class="line">    CustomMessageTypeChartlet   &#x3D; 3, &#x2F;&#x2F;贴图表情</span><br><span class="line">    CustomMessageTypeWhiteboard &#x3D; 4, &#x2F;&#x2F;白板会话</span><br><span class="line">    CustomMessageTypeRedPacket  &#x3D; 5, &#x2F;&#x2F;红包消息</span><br><span class="line">    CustomMessageTypeRedPacketTip &#x3D; 6, &#x2F;&#x2F;红包提示消息</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;自定义的消息类型</span><br><span class="line">    CustomMessageTypePersonalCard &#x3D; 7, &#x2F;&#x2F; 个人名片</span><br><span class="line">    CustomMessageTypeWebPage      &#x3D; 8, &#x2F;&#x2F; 网页链接</span><br><span class="line">    </span><br><span class="line">    CustomMessageTypeAliPayRedPacket    &#x3D; 9, &#x2F;&#x2F;红包消息</span><br><span class="line">    CustomMessageTypeAliPayRedPacketTip &#x3D; 10, &#x2F;&#x2F;红包提示消息</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;    CustomMessageTypeShareImage   &#x3D; 11, &#x2F;&#x2F; 分享图片</span><br><span class="line">    CustomMessageTypeShareApp     &#x3D; 12, &#x2F;&#x2F; 分享游戏</span><br><span class="line">    CustomMessageTypeShareLink    &#x3D; 13, &#x2F;&#x2F; 分享链接</span><br><span class="line">    CustomMessageTypeShake   &#x3D; 14, &#x2F;&#x2F; 分享链接</span><br><span class="line">    CustomMessageTypeRecord   &#x3D; 16, &#x2F;&#x2F; 战绩消息</span><br><span class="line">    </span><br><span class="line">    CustomMessageTypeCloudRedPacket &#x3D; 19, &#x2F;&#x2F;  云红包</span><br><span class="line">    CustomMessageTypeCloudRedPacketTip &#x3D; 20, &#x2F;&#x2F;</span><br><span class="line">    </span><br><span class="line">    CustomMessageTypeSystemNotification &#x3D; 21, &#x2F;&#x2F; 擦肩小助手系统通知</span><br><span class="line">    CustomMessageTypeUpdateInfo &#x3D; 22,  &#x2F;&#x2F; 擦肩小助手版本更新消息</span><br><span class="line">    CustomMessageTypeRefund &#x3D; 23,      &#x2F;&#x2F; 擦肩小助手退款消息</span><br><span class="line">    CustomMessageTypeScreenShotsNotice     &#x3D; 24, &#x2F;&#x2F;截屏通知</span><br><span class="line">    &#x2F;&#x2F;    CustomMessageTypeHelperNotice     &#x3D; 25, &#x2F;&#x2F;小助手通知</span><br><span class="line">    CustomMessageTypeArticleNotification  &#x3D; 26, &#x2F;&#x2F; 文章推送</span><br><span class="line">    CustomMessageTypeBanRedPacket  &#x3D; 27, &#x2F;&#x2F; 禁止领红包</span><br><span class="line">    CustomMessageTypeYeeRedPacket &#x3D; 28, &#x2F;&#x2F;易红包</span><br><span class="line">    CustomMessageTypeYeeRedPacketTip &#x3D; 29,</span><br><span class="line">    CustomMessageTypeYeeTransfer &#x3D; 30, &#x2F;&#x2F;易转账</span><br><span class="line">    CustomMessageTypeYeeTransferReceipt &#x3D; 31,&#x2F;&#x2F;(接收转账,退回转账)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; type -&gt; class name</span><br><span class="line">NSDictionary *attachmentMapping(void);</span><br><span class="line">NSString *attachmentNameForType(CJCustomMessageType type);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@protocol CJCustomAttachmentCoding &lt;NIMCustomAttachment&gt;</span><br><span class="line"></span><br><span class="line">@required</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 内容是否有效</span><br><span class="line"> </span><br><span class="line"> @return bool</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (BOOL)isValid;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 拼装attachment model</span><br><span class="line"> </span><br><span class="line"> @param data</span><br><span class="line"> @param type</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (instancetype)initWithPrepareData:(NSDictionary *)data;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 是否显示头像</span><br><span class="line"> </span><br><span class="line"> @return bool</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (BOOL)shouldShowNickName;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 是否显示头像</span><br><span class="line"> </span><br><span class="line"> @return bool</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (BOOL)shouldShowAvatar;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 新消息缩略语</span><br><span class="line"> </span><br><span class="line"> @return string</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (NSString *)newMsgAcronym;</span><br><span class="line"></span><br><span class="line">@optional</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> 从attachment model自定义消息</span><br><span class="line"> 之前的NTESSessionMsgConverter拆分出来，由各自attachment model类维护</span><br><span class="line"> </span><br><span class="line"> @return 消息</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (NIMMessage *)msgFromAttachment;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@protocol CJCustomAttachmentInfo &lt;NSObject&gt;</span><br><span class="line"></span><br><span class="line">@optional</span><br><span class="line"></span><br><span class="line">- (NSString *)cellContent:(NIMMessage *)message;</span><br><span class="line"></span><br><span class="line">- (CGSize)contentSize:(NIMMessage *)message cellWidth:(CGFloat)width;</span><br><span class="line"></span><br><span class="line">- (UIEdgeInsets)contentViewInsets:(NIMMessage *)message;</span><br><span class="line"></span><br><span class="line">- (NSString *)formatedMessage;</span><br><span class="line"></span><br><span class="line">- (UIImage *)showCoverImage;</span><br><span class="line"></span><br><span class="line">- (BOOL)shouldShowAvatar;</span><br><span class="line"></span><br><span class="line">- (void)setShowCoverImage:(UIImage *)image;</span><br><span class="line"></span><br><span class="line">- (BOOL)canBeRevoked;</span><br><span class="line"></span><br><span class="line">- (BOOL)canBeForwarded;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p><strong>这个类维护了一套自定义消息的类型映射和两个协议，CJCustomAttachmentCoding协议负责自定义消息model的组装和相关配置，CJCustomAttachmentInfo协议负责自定义消息布局的配置。只要实现这个类里面的协议即可完成自定义消息的添加，不需要再在额外的地方添加任何胶水代码。</strong></p>
<p><strong>第一步：CJCustomMessageType枚举里面，如果是新增的类型，则添加枚举值，并在CJCustomAttachmentDefines.m里面添加映射。<br>第二步：实现自定义消息的model类，用于管理自定义消息的数据，参见CJYeePayRedPacketAtachment。<br>第三步：实现自定义消息的contentView类，用于管理自定义消息的UI，参见CJYeeRedPacketContentView。<br>只需要以上三步，就完成了一个自定义消息的添加。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lgb1234a/CJ_Flutter">实战项目地址</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2019/10/19/Jenkins%E6%89%93%E5%8C%85%E6%89%A7%E8%A1%8CexportArchive%E6%8A%A5%EF%BC%9A%E2%80%9CNo%20valid%20Apple%20Distribution%20certificate%20found.%E2%80%9D%E9%97%AE%E9%A2%98/" class="prev">PREV</a><a href="/2018/05/29/iOS%E9%A1%B9%E7%9B%AE%E6%8B%86%E5%88%86%E5%90%8Exib%E5%AF%BC%E8%87%B4%E7%9A%84%E5%B4%A9%E6%BA%83%E5%BC%82%E5%B8%B8/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'chenyn';
var disqus_identifier = '2019/09/16/Flutter iOS实战随笔/';
var disqus_title = 'Flutter iOS实战随笔（重构之旅）';
var disqus_url = 'http://yoursite.com/2019/09/16/Flutter iOS实战随笔/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//chenyn.disqus.com/count.js" async></script><div class="copyright"><p>© 2018 - 2020 <a href="http://yoursite.com">chenynle@gmail.com</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>